<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoneyManager · AI 月度复盘</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
  </head>
  <body>
    <header class="top-nav app-shell">
      <div class="top-nav-inner">
        <a class="brand" href="/">
          <span class="brand-dot"></span>
          <span>MoneyManager</span>
        </a>
        <nav class="nav-links">
          <a class="nav-link {{ 'active' if active_page == 'index' else '' }}" href="/">首页</a>
          <a class="nav-link {{ 'active' if active_page == 'add' else '' }}" href="/add">记账</a>
          <a class="nav-link {{ 'active' if active_page == 'analysis' else '' }}" href="/analysis">分析</a>
          <a class="nav-link {{ 'active' if active_page == 'budget' else '' }}" href="/budget">预算</a>
          <a class="nav-link {{ 'active' if active_page == 'subscriptions' else '' }}" href="/subscriptions">订阅</a>
          <a class="nav-link {{ 'active' if active_page == 'ai' else '' }}" href="/ai">AI 复盘</a>
        </nav>
        <div class="nav-actions">
          <form method="get" action="/ai" class="toolbar">
            <input type="month" name="month" value="{{ month }}" />
            <button class="btn-secondary" type="submit">切换月份</button>
          </form>
          <a class="btn" href="/add">去记账</a>
        </div>
      </div>
    </header>

    <main class="app-shell">
      <div class="page">
      <section class="panel">
        <h1 class="page-title">AI 月度复盘</h1>
        <div class="page-subtitle">当前月份：{{ month }}</div>
      </section>

      <section class="panel">
        <form method="get" action="/ai" class="toolbar" style="margin-bottom: 12px;">
          <input type="month" name="month" value="{{ month }}" />
          <button class="btn-secondary" type="submit">刷新数据</button>
          <a class="btn-secondary" href="/api/ai/monthly/export?month={{ month }}">导出数据包 JSON</a>
          <button class="btn" type="button" id="copy-json-btn">复制 AI 输入数据包</button>
          <button class="btn-secondary" type="button" id="copy-prompt-btn">复制提示词模板</button>
          <button class="btn-secondary" type="button" id="copy-full-prompt-btn">复制完整提示词（模板+数据）</button>
        </form>

        <div class="grid-2">
          <div>
            <div class="small" style="margin-bottom: 6px;">内置提示词模板</div>
            <textarea id="ai-prompt-template" class="code" readonly>{{ ai_prompt_template }}</textarea>
          </div>
          <div>
            <div class="small" style="margin-bottom: 6px;">AI 输入数据包（JSON）</div>
            <textarea id="ai-package" class="code" readonly>{{ ai_package | tojson(indent=2) }}</textarea>
          </div>
        </div>
      </section>

      <section class="panel">
        {% if success == '1' %}
        <div class="msg ok">AI 输出已存档。</div>
        {% elif success == '0' %}
        <div class="msg danger">存档失败：请输入内容。</div>
        {% endif %}

        <h2 class="page-title" style="font-size: 18px;">存档 AI 输出</h2>
        <form method="post" action="/ai">
          <input type="hidden" name="month" value="{{ month }}" />
          <textarea class="code" name="content" placeholder="把 AI 的复盘输出粘贴到这里..."></textarea>
          <div class="toolbar" style="margin-top: 8px;">
            <button class="btn" type="submit">保存到本地存档</button>
          </div>
        </form>
      </section>

      <section class="panel">
        <h2 class="page-title" style="font-size: 18px;">本月历史存档</h2>
        {% if archives %}
          {% for item in archives %}
          <article class="panel" style="background: #F9FAFB; box-shadow: none; border: 1px solid #E5E7EB; margin-top: 10px;">
            <div class="small">#{{ item.id }} · {{ item.created_at }}</div>
            <div style="white-space: pre-wrap; margin-top: 8px; line-height: 1.7;">{{ item.content }}</div>
          </article>
          {% endfor %}
        {% else %}
          <p class="helper-text">本月暂无存档。</p>
        {% endif %}
      </section>
      </div>
    </main>

    <script>
      const copyButton = document.getElementById("copy-json-btn");
      const copyPromptButton = document.getElementById("copy-prompt-btn");
      const copyFullPromptButton = document.getElementById("copy-full-prompt-btn");
      const packageText = document.getElementById("ai-package");
      const promptTemplateText = document.getElementById("ai-prompt-template");

      const copyToClipboard = async (text, button, defaultText, successText) => {
        try {
          await navigator.clipboard.writeText(text);
          button.textContent = successText;
          setTimeout(() => {
            button.textContent = defaultText;
          }, 1200);
        } catch (error) {
          alert("复制失败，请手动复制文本框内容。");
        }
      };

      copyButton.addEventListener("click", async () => {
        await copyToClipboard(packageText.value, copyButton, "复制 AI 输入数据包", "已复制");
      });

      copyPromptButton.addEventListener("click", async () => {
        await copyToClipboard(promptTemplateText.value, copyPromptButton, "复制提示词模板", "已复制");
      });

      copyFullPromptButton.addEventListener("click", async () => {
        const fullPrompt = `${promptTemplateText.value}\n\n【本月数据包（JSON）】\n${packageText.value}`;
        await copyToClipboard(fullPrompt, copyFullPromptButton, "复制完整提示词（模板+数据）", "已复制");
      });
    </script>
  </body>
</html>
