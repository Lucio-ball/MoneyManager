<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoneyManager · 分析页面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header class="top-nav app-shell">
      <div class="top-nav-inner">
        <a class="brand" href="/">
          <span class="brand-dot"></span>
          <span>MoneyManager</span>
        </a>
        <nav class="nav-links">
          <a class="nav-link {{ 'active' if active_page == 'index' else '' }}" href="/">首页</a>
          <a class="nav-link {{ 'active' if active_page == 'add' else '' }}" href="/add">记账</a>
          <a class="nav-link {{ 'active' if active_page == 'analysis' else '' }}" href="/analysis">分析</a>
          <a class="nav-link {{ 'active' if active_page == 'budget' else '' }}" href="/budget">预算</a>
          <a class="nav-link {{ 'active' if active_page == 'subscriptions' else '' }}" href="/subscriptions">订阅</a>
          <a class="nav-link {{ 'active' if active_page == 'ai' else '' }}" href="/ai">AI 复盘</a>
        </nav>
        <div class="nav-actions">
          <form method="get" action="/analysis" class="toolbar">
            <input type="month" name="month" value="{{ month }}" />
            <button class="btn-secondary" type="submit">切换月份</button>
          </form>
          <a class="btn" href="/add">去记账</a>
        </div>
      </div>
    </header>

    <main class="app-shell">
      <div class="page">
      <section class="panel">
        <h1 class="page-title">分析页面</h1>
        <div class="page-subtitle">月份：{{ month }}</div>
      </section>

      <section class="panel">
        <form class="toolbar" method="get" action="/analysis">
          <input type="month" name="month" value="{{ month }}" />
          <select name="category">
            {% for category in category_options %}
            <option value="{{ category }}" {% if category == category_name %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
          </select>
          <select name="tag">
            {% for tag in tag_options %}
            <option value="{{ tag }}" {% if tag == tag_name %}selected{% endif %}>{{ tag }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit">更新分析</button>
        </form>
      </section>

      <section class="kpi-grid" style="grid-template-columns: repeat(5, minmax(0, 1fr));">
          <article class="kpi-card">
            <div class="kpi-label">总支出</div>
            <div class="kpi-value expense mono">¥{{ '%.2f'|format(monthly_stats.total_expense) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">总收入</div>
            <div class="kpi-value income mono">¥{{ '%.2f'|format(monthly_stats.total_income) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">结余</div>
            <div class="kpi-value mono">¥{{ '%.2f'|format(monthly_stats.balance) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">订阅折算成本</div>
            <div class="kpi-value expense mono">¥{{ '%.2f'|format(subscription_metrics.estimated_monthly_cost) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">订阅占比</div>
            <div class="kpi-value mono">{{ '%.2f'|format(subscription_ratio) }}%</div>
          </article>
        </div>
      </section>

      <section class="grid-2">
        <div class="panel">
          <h3 class="page-title" style="font-size: 18px;">类别统计（金额 + 占比）</h3>
          {% if monthly_stats.category_stats %}
          <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>类别</th>
                <th>金额</th>
                <th>占比</th>
              </tr>
            </thead>
            <tbody>
              {% for item in monthly_stats.category_stats %}
              <tr>
                <td>{{ item.name }}</td>
                <td>¥{{ '%.2f'|format(item.amount) }}</td>
                <td>{{ '%.2f'|format(item.ratio) }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% else %}
          <div class="helper-text">当前月份暂无类别支出数据。</div>
          {% endif %}
        </div>

        <div class="panel">
          <h3 class="page-title" style="font-size: 18px;">标签统计（金额 + 占比）</h3>
          {% if monthly_stats.tag_stats %}
          <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>标签</th>
                <th>金额</th>
                <th>占比</th>
              </tr>
            </thead>
            <tbody>
              {% for item in monthly_stats.tag_stats %}
              <tr>
                <td>{{ item.name }}</td>
                <td>¥{{ '%.2f'|format(item.amount) }}</td>
                <td>{{ '%.2f'|format(item.ratio) }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
          {% else %}
          <div class="helper-text">当前月份暂无标签支出数据。</div>
          {% endif %}
        </div>
      </section>

      <section class="grid-2">
        <div class="panel">
          <h3 class="page-title" style="font-size: 18px;">类别趋势（最近 3 个月）- {{ category_name }}</h3>
          <canvas id="categoryTrendChart" height="140"></canvas>
        </div>
        <div class="panel">
          <h3 class="page-title" style="font-size: 18px;">标签趋势（最近 3 个月）- {{ tag_name }}</h3>
          <canvas id="tagTrendChart" height="140"></canvas>
        </div>
      </section>

      <section class="panel">
        <h2 class="page-title" style="font-size: 18px;">行为模式识别</h2>
        <p class="helper-text">
          冲动消费比例：{{ '%.2f'|format(insights.impulsive_spending_ratio.ratio) }}%（¥{{ '%.2f'|format(insights.impulsive_spending_ratio.amount) }}）
          ｜ 学习投资比例：{{ '%.2f'|format(insights.learning_investment_ratio.ratio) }}%（¥{{ '%.2f'|format(insights.learning_investment_ratio.amount) }}）
        </p>

        <h3>异常高支出日</h3>
        {% if insights.abnormal_high_expense_days %}
        <ul>
          {% for item in insights.abnormal_high_expense_days %}
          <li>{{ item.date }}：¥{{ '%.2f'|format(item.amount) }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="helper-text">本月暂无异常高支出日。</div>
        {% endif %}

        <h3>长期高占比类别（最近 3 个月）</h3>
        {% if insights.long_term_high_ratio_categories %}
        <ul>
          {% for item in insights.long_term_high_ratio_categories %}
          <li>{{ item.category }}：{{ item.ratios | join('% / ') }}%</li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="helper-text">暂无连续 3 个月高占比类别。</div>
        {% endif %}
      </section>
      </div>
    </main>

    <script id="analysis-data" type="application/json">
      {{ {'category_trend': category_trend, 'tag_trend': tag_trend} | tojson }}
    </script>

    <script>
      const dataElement = document.getElementById("analysis-data");
      const analysisData = dataElement
        ? JSON.parse(dataElement.textContent)
        : { category_trend: { trend: [] }, tag_trend: { trend: [] } };

      const categoryTrend = analysisData.category_trend?.trend || [];
      const tagTrend = analysisData.tag_trend?.trend || [];

      new Chart(document.getElementById("categoryTrendChart"), {
        type: "line",
        data: {
          labels: categoryTrend.map((item) => item.month),
          datasets: [
            {
              label: "类别支出",
              data: categoryTrend.map((item) => item.amount),
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.2)",
              fill: true,
              tension: 0.25,
            },
          ],
        },
        options: {
          plugins: { legend: { labels: { color: "#374151" } } },
          scales: {
            x: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
            y: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
          },
        },
      });

      new Chart(document.getElementById("tagTrendChart"), {
        type: "line",
        data: {
          labels: tagTrend.map((item) => item.month),
          datasets: [
            {
              label: "标签支出",
              data: tagTrend.map((item) => item.amount),
              borderColor: "#7c3aed",
              backgroundColor: "rgba(124, 58, 237, 0.2)",
              fill: true,
              tension: 0.25,
            },
          ],
        },
        options: {
          plugins: { legend: { labels: { color: "#374151" } } },
          scales: {
            x: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
            y: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
          },
        },
      });
    </script>
  </body>
</html>
