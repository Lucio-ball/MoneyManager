<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoneyManager · 预算设置</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
  </head>
  <body>
    <header class="top-nav app-shell">
      <div class="top-nav-inner">
        <a class="brand" href="/">
          <span class="brand-dot"></span>
          <span>MoneyManager</span>
        </a>
        <nav class="nav-links">
          <a class="nav-link {{ 'active' if active_page == 'index' else '' }}" href="/">首页</a>
          <a class="nav-link {{ 'active' if active_page == 'add' else '' }}" href="/add">记账</a>
          <a class="nav-link {{ 'active' if active_page == 'analysis' else '' }}" href="/analysis">分析</a>
          <a class="nav-link {{ 'active' if active_page == 'budget' else '' }}" href="/budget">预算</a>
          <a class="nav-link {{ 'active' if active_page == 'subscriptions' else '' }}" href="/subscriptions">订阅</a>
          <a class="nav-link {{ 'active' if active_page == 'ai' else '' }}" href="/ai">AI 复盘</a>
        </nav>
        <div class="nav-actions">
          <form method="get" action="/budget" class="toolbar">
            <input type="month" name="month" value="{{ month }}" />
            <button class="btn-secondary" type="submit">切换月份</button>
          </form>
          <a class="btn" href="/add">去记账</a>
        </div>
      </div>
    </header>

    <main class="app-shell">
      <div class="page">
      <section class="panel">
        <h1 class="page-title">预算模块</h1>
        <div class="page-subtitle">当前月份：{{ month }}</div>
      </section>

      <section class="panel">
        {% if success == '1' %}
        <div class="msg ok">预算已保存。</div>
        {% elif success == '0' %}
        <div class="msg danger">保存失败：请填写有效预算金额。</div>
        {% endif %}

        <form method="post" action="/budget" class="toolbar" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto;">
          <input type="month" name="month" value="{{ month }}" required />
          <select name="category_main">
            <option value="">总预算（不选类别）</option>
            {% for category in category_options %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
          </select>
          <input type="number" step="0.01" min="0.01" name="budget_amount" placeholder="预算金额" required />
          <button class="btn" type="submit">保存预算</button>
        </form>
      </section>

      <section class="panel">
        <h2 class="page-title" style="font-size: 18px;">预算执行情况</h2>
        <p class="helper-text">本月实际总支出：¥{{ '%.2f'|format(budget_data.total_expense) }}</p>

        {% if budget_data['items'] %}
        <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>类别</th>
              <th>预算</th>
              <th>实际支出</th>
              <th>执行率</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody>
            {% for item in budget_data['items'] %}
            <tr>
              <td>{{ item.category_main if item.category_main else '总预算' }}</td>
              <td>¥{{ '%.2f'|format(item.budget_amount) }}</td>
              <td>¥{{ '%.2f'|format(item.actual_expense) }}</td>
              <td>{{ '%.2f'|format(item.execution_rate) }}%</td>
              <td>
                {% if item.status == '正常' %}
                <span class="badge ok">正常</span>
                {% elif item.status == '接近' %}
                <span class="badge warn">接近</span>
                {% else %}
                <span class="badge danger">超支</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
        {% else %}
        <p class="helper-text">暂无预算记录，请先新增一条预算。</p>
        {% endif %}
      </section>
      </div>
    </main>
  </body>
</html>
