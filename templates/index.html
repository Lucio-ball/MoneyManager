<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoneyManager · 首页仪表盘</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header class="top-nav app-shell">
      <div class="top-nav-inner">
        <a class="brand" href="/">
          <span class="brand-dot"></span>
          <span>MoneyManager</span>
        </a>
        <nav class="nav-links">
          <a class="nav-link {{ 'active' if active_page == 'index' else '' }}" href="/">首页</a>
          <a class="nav-link {{ 'active' if active_page == 'add' else '' }}" href="/add">记账</a>
          <a class="nav-link {{ 'active' if active_page == 'analysis' else '' }}" href="/analysis">分析</a>
          <a class="nav-link {{ 'active' if active_page == 'budget' else '' }}" href="/budget">预算</a>
          <a class="nav-link {{ 'active' if active_page == 'subscriptions' else '' }}" href="/subscriptions">订阅</a>
          <a class="nav-link {{ 'active' if active_page == 'ai' else '' }}" href="/ai">AI 复盘</a>
        </nav>
        <div class="nav-actions">
          <form method="get" action="/" class="toolbar">
            <input type="month" name="month" value="{{ month }}" />
            <button class="btn-secondary" type="submit">切换月份</button>
          </form>
          <a class="btn" href="/add">去记账</a>
        </div>
      </div>
    </header>

    <main class="app-shell">
      <div class="page">
        <section class="panel">
          <h1 class="page-title">首页仪表盘</h1>
          <div class="page-subtitle">当前月份：{{ month }}</div>
        </section>

        <section class="kpi-grid">
          <article class="kpi-card">
            <div class="kpi-label">本月总支出</div>
            <div class="kpi-value expense mono">¥{{ '%.2f'|format(summary.total_expense) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">本月总收入</div>
            <div class="kpi-value income mono">¥{{ '%.2f'|format(summary.total_income) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">本月结余</div>
            <div class="kpi-value mono">¥{{ '%.2f'|format(summary.balance) }}</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-label">今日支出</div>
            <div class="kpi-value expense mono">¥{{ '%.2f'|format(today_expense) }}</div>
          </article>
        </section>

        <section class="layout-main">
          <article class="panel">
            <h2 class="page-title" style="font-size: 18px;">每日支出趋势</h2>
            <div class="small">本月每日支出折线图</div>
            {% if daily_expense %}
            <canvas id="dailyExpenseChart" height="120" style="margin-top: 12px;"></canvas>
            {% else %}
            <div class="helper-text">该月份暂无支出数据。</div>
            {% endif %}
          </article>

          <div class="stack">
            <article class="panel emotion-card">
              <div class="status-dot {{ emotion_light.level }}"></div>
              <div class="kpi-label">本月状态</div>
              <div class="status-text">{{ emotion_light.label }} · {{ emotion_light.reason }}</div>
            </article>

            <article class="panel">
              <h2 class="page-title" style="font-size: 18px;">类别占比</h2>
              {% if category_share %}
              <canvas id="categoryPieChart" height="180" style="margin-top: 12px;"></canvas>
              {% else %}
              <div class="helper-text">该月份暂无类别数据。</div>
              {% endif %}
            </article>

            <article class="panel">
              <h2 class="page-title" style="font-size: 18px;">本月前三类别</h2>
              {% if top_categories %}
              <div class="category-list" style="margin-top: 10px;">
                {% for item in top_categories %}
                <div class="category-item">
                  <div class="category-main">
                    <div class="category-name">
                      <span class="color-dot" style="background: {{ item.color }};"></span>
                      <span>{{ item.name }}</span>
                    </div>
                    <div class="progress">
                      <span style="width: {{ item.ratio }}%; background: {{ item.color }};"></span>
                    </div>
                  </div>
                  <div class="mono" style="text-align: right;">
                    <div>¥{{ '%.2f'|format(item.amount) }}</div>
                    <div class="small">{{ '%.2f'|format(item.ratio) }}%</div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="helper-text">暂无类别数据。</div>
              {% endif %}
            </article>

            <article class="panel">
              <h2 class="page-title" style="font-size: 18px;">订阅提醒</h2>
              <div class="kpi-label" style="margin-top: 8px;">
                本月预计订阅成本：<span class="mono">¥{{ '%.2f'|format(subscription_metrics.estimated_monthly_cost) }}</span>
                ｜ 本月实际订阅扣费：<span class="mono">¥{{ '%.2f'|format(subscription_metrics.actual_charged_amount) }}</span>
                ｜ 未来 7 天：{{ subscription_summary.upcoming_count }} 项
              </div>
              {% if subscription_upcoming %}
              <div class="category-list" style="margin-top: 10px;">
                {% for item in subscription_upcoming %}
                <div class="category-item">
                  <div class="category-main">
                    <div class="category-name">
                      <span>{{ item.name }}</span>
                    </div>
                    <div class="small">{{ item.next_billing_date }} · {{ item.cycle }}</div>
                  </div>
                  <div class="mono" style="text-align: right;">
                    <div>¥{{ '%.2f'|format(item.amount) }}</div>
                    <div class="small">月折算 ¥{{ '%.2f'|format(item.monthly_cost) }}</div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="helper-text">未来 7 天暂无订阅扣费。</div>
              {% endif %}
            </article>
          </div>
        </section>
      </div>
    </main>

    <script id="dashboard-data" type="application/json">
      {{ {'daily_expense': daily_expense, 'category_share': category_share} | tojson }}
    </script>

    <script>
      const dashboardDataElement = document.getElementById("dashboard-data");
      const dashboardData = dashboardDataElement
        ? JSON.parse(dashboardDataElement.textContent)
        : { daily_expense: [], category_share: [] };

      const dailyExpense = dashboardData.daily_expense || [];
      const categoryShare = dashboardData.category_share || [];

      if (dailyExpense.length > 0) {
        const dailyCtx = document.getElementById("dailyExpenseChart");
        new Chart(dailyCtx, {
          type: "line",
          data: {
            labels: dailyExpense.map((item) => item.date),
            datasets: [
              {
                label: "每日支出",
                data: dailyExpense.map((item) => item.amount),
                borderColor: "#2563EB",
                backgroundColor: "rgba(37, 99, 235, 0.14)",
                pointRadius: 2,
                pointHoverRadius: 4,
                borderWidth: 2.2,
                tension: 0.36,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, labels: { color: "#374151" } },
            },
            scales: {
              x: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
              y: { grid: { color: "rgba(107, 114, 128, 0.08)" }, ticks: { color: "#6B7280" } },
            },
          },
        });
      }

      if (categoryShare.length > 0) {
        const pieCtx = document.getElementById("categoryPieChart");
        new Chart(pieCtx, {
          type: "pie",
          data: {
            labels: categoryShare.map((item) => item.category),
            datasets: [
              {
                data: categoryShare.map((item) => item.amount),
                borderWidth: 0,
                backgroundColor: [
                  "#2563EB",
                  "#0EA5E9",
                  "#14B8A6",
                  "#22C55E",
                  "#F59E0B",
                  "#EF4444",
                  "#8B5CF6",
                  "#64748B",
                ],
              },
            ],
          },
          options: {
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#374151", boxWidth: 10, usePointStyle: true, pointStyle: "circle" },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
